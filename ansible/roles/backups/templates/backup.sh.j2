#!/bin/bash
set -euo pipefail

# Backup script for BlindStrader - {{ environment }}
BACKUP_DIR="/tmp/blindstrader-backup"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
S3_BUCKET="{{ backup_s3_bucket }}"
ENVIRONMENT="{{ environment }}"

echo "[$(date)] Starting backup for ${ENVIRONMENT}..."

# Create backup directory
mkdir -p ${BACKUP_DIR}

# Backup MySQL
echo "[$(date)] Backing up MySQL..."
docker exec mysql mysqldump --all-databases \
  --single-transaction \
  --quick \
  --lock-tables=false \
  > ${BACKUP_DIR}/mysql_${TIMESTAMP}.sql

# Backup Redis
echo "[$(date)] Backing up Redis..."
docker exec redis redis-cli SAVE
docker cp redis:/data/dump.rdb ${BACKUP_DIR}/redis_${TIMESTAMP}.rdb

# Create tarball
echo "[$(date)] Creating archive..."
cd ${BACKUP_DIR}
tar -czf backup_${TIMESTAMP}.tar.gz mysql_${TIMESTAMP}.sql redis_${TIMESTAMP}.rdb

# Encrypt with GPG
echo "[$(date)] Encrypting backup..."
gpg --encrypt \
  --recipient admin@blindstrader.com \
  --trust-model always \
  --output backup_${TIMESTAMP}.tar.gz.gpg \
  backup_${TIMESTAMP}.tar.gz

# Upload to S3
echo "[$(date)] Uploading to S3..."
aws s3 cp backup_${TIMESTAMP}.tar.gz.gpg \
  s3://${S3_BUCKET}/${ENVIRONMENT}/backup_${TIMESTAMP}.tar.gz.gpg

# Cleanup
echo "[$(date)] Cleaning up..."
rm -rf ${BACKUP_DIR}

echo "[$(date)] Backup completed successfully!"

# Delete backups older than 30 days from S3
echo "[$(date)] Cleaning old backups from S3..."
aws s3 ls s3://${S3_BUCKET}/${ENVIRONMENT}/ | while read -r line; do
  createDate=$(echo $line | awk {'print $1" "$2'})
  createDate=$(date -d "$createDate" +%s)
  olderThan=$(date -d "30 days ago" +%s)
  if [[ $createDate -lt $olderThan ]]; then
    fileName=$(echo $line | awk {'print $4'})
    if [[ $fileName != "" ]]; then
      echo "Deleting old backup: $fileName"
      aws s3 rm s3://${S3_BUCKET}/${ENVIRONMENT}/$fileName
    fi
  fi
done

echo "[$(date)] Backup process finished!"
